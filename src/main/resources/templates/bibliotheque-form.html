<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title
      th:text="${bibliotheque.id == null ? 'Add Library' : 'Edit Library'}"
    >
      Library
    </title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Bootstrap & Icons via CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <style>
      :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
      }

      body {
        background: #f5f7fa;
        min-height: 100vh;
        padding: 2rem 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .form-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .form-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      .form-header {
        background: #4a90e2;
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .form-header h2 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .form-header i {
        font-size: 2rem;
      }

      .form-body {
        padding: 2.5rem;
      }

      .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-title i {
        color: var(--primary-color);
        font-size: 1.5rem;
      }

      .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-label i {
        color: var(--primary-color);
      }

      .form-control,
      .form-select {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s;
        font-size: 1rem;
      }

      .map-wrapper {
        padding: 1rem;
        border: 2px solid #e0e0e0;

        background: #fff;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
        overflow: hidden; /* Empêche le débordement */
      }
      form {
        padding-bottom: 2rem;
      }

      .map-container {
        height: 320px;
        width: 100%;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .btn-submit {
        background: #4a90e2;
        border: none;
        color: white;
        padding: 1rem 3rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: transform 0.3s, box-shadow 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4);
        background: #357abd;
      }

      .btn-cancel {
        background: #6c757d;
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-cancel:hover {
        background: #5a6268;
        color: white;
        transform: translateY(-2px);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #f0f0f0;
      }

      @media (max-width: 768px) {
        .form-body {
          padding: 1.5rem;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn-submit,
        .btn-cancel {
          width: 100%;
          justify-content: center;
        }
      }

      #map {
        height: 320px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <!-- Brand -->
        <a class="navbar-brand fw-bold" th:href="@{/home}">
          <i class="bi bi-book"></i> Library
        </a>

        <!-- Toggle mobile -->
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarContent"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
          <!-- LEFT MENU -->
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <!-- Home : tout le monde -->
            <li class="nav-item">
              <a class="nav-link" th:href="@{/home}">
                <i class="bi bi-house"></i> Home
              </a>
            </li>

            <!-- Resources : ADMIN + BIBLIOTHECAIRE -->
            <li
              class="nav-item"
              sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')"
            >
              <a class="nav-link" th:href="@{/ressources}">
                <i class="bi bi-box-seam"></i> Resources
              </a>
            </li>

            <!-- Bibliothèques : ADMIN + BIBLIOTHECAIRE -->
            <li
              class="nav-item"
              sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')"
            >
              <a class="nav-link" th:href="@{/bibliotheques}">
                <i class="bi bi-building"></i> Libraries
              </a>
            </li>

            <!-- Loans -->
            <li class="nav-item" sec:authorize="isAuthenticated()">
              <a class="nav-link" th:href="@{/loans}">
                <i class="bi bi-journal-text"></i> Loans
              </a>
            </li>
          </ul>

          <!-- RIGHT MENU -->
          <ul class="navbar-nav ms-auto">
            <!-- Username -->
            <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-person-circle"></i>
                <span sec:authentication="name"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <form th:action="@{/logout}" method="post">
                    <button class="dropdown-item text-danger">
                      <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                  </form>
                </li>
              </ul>
            </li>

            <!-- Login -->
            <li class="nav-item" sec:authorize="!isAuthenticated()">
              <a class="nav-link" th:href="@{/login}">
                <i class="bi bi-box-arrow-in-right"></i> Login
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="form-container">
      <div class="form-card">
        <div class="form-header">
          <h2>
            <i
              th:class="${bibliotheque.id == null ? 'bi bi-plus-circle-fill' : 'bi bi-pencil-square'}"
            ></i>
            <span
              th:text="${bibliotheque.id == null ? 'Add Library' : 'Edit Library'}"
            ></span>
          </h2>
        </div>

        <div class="form-body">
          <form
            th:action="@{/bibliotheques/save}"
            th:object="${bibliotheque}"
            method="post"
          >
            <input type="hidden" th:field="*{id}" />

            <!-- Name -->
            <div class="mb-4">
              <label class="form-label"
                ><i class="bi bi-building"></i> Name</label
              >
              <input
                type="text"
                th:field="*{nom}"
                class="form-control"
                placeholder="Library name"
              />
              <div
                class="text-danger"
                th:if="${#fields.hasErrors('nom')}"
                th:errors="*{nom}"
              ></div>
            </div>

            <!-- Code -->
            <div class="mb-4">
              <label class="form-label"
                ><i class="bi bi-upc-scan"></i> Code</label
              >
              <input
                type="text"
                th:field="*{code}"
                class="form-control"
                placeholder="Unique code"
              />
              <div
                class="text-danger"
                th:if="${#fields.hasErrors('code')}"
                th:errors="*{code}"
              ></div>
            </div>

            <!-- Schedule -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="bi bi-clock-fill"></i> Schedule
              </h3>

              <div class="mb-4">
                <label class="form-label">Weekdays (Mon-Fri)</label>
                <input
                  type="text"
                  th:field="*{horaireSemaine}"
                  class="form-control"
                  placeholder="08:00-17:00"
                />
                <div
                  class="text-danger"
                  th:if="${#fields.hasErrors('horaireSemaine')}"
                  th:errors="*{horaireSemaine}"
                ></div>
              </div>

              <div class="mb-4">
                <label class="form-label">Weekend (Sat & Sun)</label>
                <input
                  type="text"
                  th:field="*{horaireWeekend}"
                  class="form-control"
                  placeholder="09:00-12:00"
                />
                <div
                  class="text-danger"
                  th:if="${#fields.hasErrors('horaireWeekend')}"
                  th:errors="*{horaireWeekend}"
                ></div>
              </div>
            </div>

            <!-- Address -->
            <div class="mb-4">
              <label class="form-label"
                ><i class="bi bi-geo-alt-fill"></i> Address</label
              >
              <input
                type="text"
                th:field="*{adresse}"
                class="form-control"
                placeholder="Address"
              />
            </div>

            <!-- Parent -->
            <div class="mb-4">
              <label class="form-label"
                ><i class="bi bi-diagram-3-fill"></i> Parent</label
              >
              <select th:field="*{parentId}" class="form-select">
                <option value="">-- None (central library) --</option>
                <option
                  th:each="bib : ${bibliotheques}"
                  th:value="${bib.id}"
                  th:text="${bib.nom}"
                ></option>
              </select>
              <div
                class="text-danger"
                th:if="${#fields.hasErrors('parentId')}"
                th:errors="*{parentId}"
              ></div>
            </div>

            <!-- Latitude / Longitude -->
            <div class="mb-4">
              <label class="form-label">Latitude</label>
              <input
                type="number"
                step="any"
                th:field="*{latitude}"
                class="form-control"
                id="latitude"
              />
              <div
                class="text-danger"
                th:if="${#fields.hasErrors('latitude')}"
                th:errors="*{latitude}"
              ></div>
            </div>

            <div class="mb-4">
              <label class="form-label">Longitude</label>
              <input
                type="number"
                step="any"
                th:field="*{longitude}"
                class="form-control"
                id="longitude"
              />
              <div
                class="text-danger"
                th:if="${#fields.hasErrors('longitude')}"
                th:errors="*{longitude}"
              ></div>
            </div>

            <!-- <div class="mb-4">
              <label class="form-label">Location</label>
              <div id="map"></div>
              <small class="text-muted"
                >Click on the map to place the marker (draggable).</small
              >
            </div> -->

            <div class="form-section">
              <h3 class="section-title">
                <i class="bi bi-geo-alt-fill"></i>
                Location
              </h3>
              <div class="map-wrapper">
                <div id="map" class="map-container"></div>
              </div>
              <small class="text-muted">
                Click on the map to place the marker (draggable).
              </small>
            </div>

            <div class="form-actions">
              <a th:href="@{/bibliotheques}" class="btn-cancel"
                ><i class="bi bi-x-circle"></i> Cancel</a
              >
              <button type="submit" class="btn-submit">
                <i class="bi bi-check-circle"></i> Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      crossorigin=""
    ></script>

    <script>
      setTimeout(() => {
        map.invalidateSize(); // Force Leaflet à recalculer la taille
      }, 100);

      document.addEventListener("DOMContentLoaded", () => {
        const mapEl = document.getElementById("map");
        const latInput = document.getElementById("latitude");
        const lngInput = document.getElementById("longitude");
        const adrInput = document.querySelector('input[name="adresse"]');

        const lat0 = latInput.value ? parseFloat(latInput.value) : 36.8065;
        const lng0 = lngInput.value ? parseFloat(lngInput.value) : 10.1815;

        const map = L.map(mapEl).setView([lat0, lng0], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
          maxZoom: 20,
        }).addTo(map);

        let marker = L.marker([lat0, lng0], { draggable: true }).addTo(map);

        async function reverseGeocode(lat, lng) {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&addressdetails=1`;
          try {
            const res = await fetch(url, {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error("Reverse geocode HTTP " + res.status);
            const data = await res.json();
            if (data && data.display_name) adrInput.value = data.display_name;
          } catch (e) {
            console.warn("Reverse geocoding failed:", e);
          }
        }

        function setLatLng(lat, lng, doReverse = true) {
          latInput.value = Number(lat).toFixed(6);
          lngInput.value = Number(lng).toFixed(6);
          marker.setLatLng([lat, lng]);
          if (doReverse) reverseGeocode(lat, lng);
        }

        map.on("click", (e) => setLatLng(e.latlng.lat, e.latlng.lng, true));
        marker.on("dragend", () => {
          const p = marker.getLatLng();
          setLatLng(p.lat, p.lng, true);
        });

        function onInputChange() {
          const lat = parseFloat(latInput.value);
          const lng = parseFloat(lngInput.value);
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            marker.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
            reverseGeocode(lat, lng);
          }
        }
        latInput.addEventListener("change", onInputChange);
        lngInput.addEventListener("change", onInputChange);

        if (!adrInput.value || adrInput.value.trim() === "")
          reverseGeocode(lat0, lng0);
      });
    </script>
  </body>
</html>
