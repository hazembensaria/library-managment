<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="'Copies for: ' + ${ressource.titre}">Copies</title>

  <!-- Bootstrap & Icons via CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

  <style>
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
    }

    body {
      background: #f5f7fa;
      min-height: 100vh;
      padding: 2rem 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .page-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .page-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .page-header {
      background: #4a90e2;
      color: white;
      padding: 2rem;
    }

    .page-header h2 {
      margin: 0;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .page-header h2 i {
      font-size: 2rem;
    }

    .page-header .subtitle {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .page-body {
      padding: 2rem 2.5rem 2.5rem 2.5rem;
    }

    .top-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .btn-primary-custom {
      background: #4a90e2;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      padding: 0.6rem 1.4rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary-custom:hover {
      background: #357abd;
    }

    .btn-secondary-custom {
      background: #6c757d;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      padding: 0.5rem 1.2rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: white;
      text-decoration: none;
    }

    .btn-secondary-custom:hover {
      background: #5a6268;
      color: white;
    }

    .table thead th {
      border-bottom-width: 2px;
      color: #495057;
      font-weight: 600;
    }

    .badge-available {
      background-color: #28a745;
    }

    .badge-unavailable {
      background-color: #dc3545;
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 2.5rem;
      color: #ced4da;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
      .page-body {
        padding: 1.5rem;
      }

      .top-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .top-actions .btn-primary-custom,
      .top-actions .btn-secondary-custom {
        width: 100%;
        justify-content: center;
      }

      .table-responsive {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <div class="page-container">
    <div class="page-card">
      <!-- Header -->
      <div class="page-header">
        <h2>
          <i class="bi bi-collection"></i>
          <span th:text="'Copies for: ' + ${ressource.titre}">
            Copies for: Title of the resource
          </span>
        </h2>
          <div class="subtitle">
          Resource ID:
          <span th:text="${ressource.id}">1</span>
        </div>
      </div>

      <!-- Body -->
      <div class="page-body">
        <!-- Top actions: back to resources + add copy -->
        <div class="top-actions">
          <a href="/ressources" class="btn-secondary-custom">
            <i class="bi bi-arrow-left"></i>
            Back to resources list
          </a>

          <a th:href="@{'/exemplaires/add/' + ${ressource.id}}" class="btn-primary-custom"
            sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')">
            <i class="bi bi-plus-circle"></i>
            Add a copy
          </a>
        </div>

        <!-- Table or empty state -->
        <div th:if="${#lists.isEmpty(exemplaires)}" class="empty-state">
          <i class="bi bi-inbox"></i>
          <p class="mt-2 mb-1">
            No copies have been added for this resource yet.
          </p>
          <p class="mb-0">
            Click on
            <strong>“Add a copy”</strong>
            to create the first one.
          </p>
        </div>

        <div th:if="${!#lists.isEmpty(exemplaires)}" class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th scope="col">Barcode</th>
                <th scope="col">Library</th>
                <th scope="col">Condition</th>
                <th scope="col">Available</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="ex : ${exemplaires}">
                <td th:text="${ex.codeBarre}">123456789</td>
                <td th:text="${ex.bibliotheque.nom}">Main Library</td>
                <td th:text="${ex.etat}">Good</td>

                <!-- Available badge -->
                <td>
                  <span class="badge" th:classappend="${ex.disponible} ? ' badge-available' : ' badge-unavailable'"
                    th:text="${ex.disponible} ? 'Yes' : 'No'">
                    Yes
                  </span>
                </td>

                <!-- Actions -->
                <td class="text-end">
                  <!-- Reservation by logged-in user (ROLE_USER only) -->
                  <button type="button" class="btn btn-sm me-2 btn-reserve" sec:authorize="hasAuthority('USER')"
                    th:classappend="${ex.disponible} ? ' btn-primary' : ' btn-secondary disabled'"
                    th:attr="data-ex-id=${ex.id},aria-disabled=${!ex.disponible}" th:disabled="${!ex.disponible}">
                    <i class="bi bi-bookmark-plus"></i>
                    <span th:text="${ex.disponible} ? 'Reserve' : 'Not available'">Reserve</span>
                  </button>

                  <!-- Reservation for a user (ADMIN or BIBLIOTHECAIRE) -->
                  <button type="button" class="btn btn-sm me-2 btn-reserve-admin btn-outline-primary"
                    sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')" th:attr="data-ex-id=${ex.id}">
                    <i class="bi bi-person-plus"></i>
                    Reserve for user
                  </button>
                  <a th:href="@{'/exemplaires/delete/' + ${ex.id}}" class="btn btn-sm btn-outline-danger"
                    sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')"
                    onclick="return confirm('Are you sure you want to delete this copy?');">
                    <i class="bi bi-trash"></i>
                    Delete
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Reservation success modal -->
  <div class="modal fade" id="reserveSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 2rem;">
          <div style="display: flex; align-items: center; gap: 1rem; width: 100%;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-check-circle-fill" style="font-size: 28px;"></i>
            </div>
            <div>
              <h5 class="modal-title mb-0" style="font-weight: 700; font-size: 1.5rem;">Successful Reservation</h5>
              <p class="mb-0" style="opacity: 0.9; font-size: 0.9rem;">Your reservation has been recorded</p>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="opacity: 0.8;"></button>
        </div>
        <div class="modal-body" id="reserveSuccessBody" style="padding: 2rem; background: #f8f9fa;"></div>
        <div class="modal-footer" style="border: none; padding: 1.5rem 2rem; background: #f8f9fa;">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.6rem 2rem; font-weight: 600; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            Perfect, thank you!
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin modal: enter target user -->
  <div class="modal fade" id="adminReserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Reserve for a user</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">User ID</label>
            <input type="number" class="form-control" id="adminUserIdInput" placeholder="Enter user ID" />
          </div>
          <input type="hidden" id="adminExIdInput" />
          <div class="alert alert-danger d-none" id="adminReserveError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="adminReserveConfirmBtn">
            Reserve
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const modalEl = document.getElementById("reserveSuccessModal");
      const modal = new bootstrap.Modal(modalEl);
      const bodyEl = document.getElementById("reserveSuccessBody");

      const adminModalEl = document.getElementById("adminReserveModal");
      const adminModal = adminModalEl
        ? new bootstrap.Modal(adminModalEl)
        : null;
      const adminUserIdInput = document.getElementById("adminUserIdInput");
      const adminExIdInput = document.getElementById("adminExIdInput");
      const adminErrorBox = document.getElementById("adminReserveError");
      const adminConfirmBtn = document.getElementById(
        "adminReserveConfirmBtn"
      );

      document.querySelectorAll(".btn-reserve").forEach((btn) => {
        btn.addEventListener("click", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          
          const exId = btn.getAttribute("data-ex-id");
          if (!exId || btn.disabled || btn.classList.contains("processing")) {
            return;
          }

          // Immediately disable the button and add a loading indicator
          btn.disabled = true;
          btn.classList.add("processing");
          const originalContent = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Réservation...';
          
          try {
            const params = new URLSearchParams({ exemplaireId: exId });
            const res = await fetch(
              "/api/loans/reserve?" + params.toString(),
              { method: "POST" }
            );
            const data = await res.json();

            if (!res.ok || data.error) {
              // Re-enable the button on error
              btn.disabled = false;
              btn.classList.remove("processing");
              btn.innerHTML = originalContent;
              alert(data.error || "Error during reservation.");
              return;
            }

            const loanId = data.id;
            const exemplaire = data.exemplaire || {};
            const ressource = exemplaire.ressource || {};
            const user = data.user || {};

            const titre = ressource.titre || "Unknown resource";
            const codeBarre = exemplaire.codeBarre || exemplaire.id || exId;
            const userId = user.id || "unknown";
            const fullName =
              (user.firstname || "") + " " + (user.lastname || "");

            // Mettre à jour la ligne dans le tableau (badge + bouton)
            const row = btn.closest("tr");
            if (row) {
              const badge = row.querySelector("td:nth-child(4) .badge");
              if (badge) {
                badge.classList.remove("badge-available");
                badge.classList.add("badge-unavailable");
                badge.textContent = "No";
              }
              btn.classList.remove("btn-primary");
              btn.classList.add("btn-secondary", "disabled");
              btn.setAttribute("aria-disabled", "true");
              btn.disabled = true;
              const span = btn.querySelector("span");
              if (span) span.textContent = "Not available";
            }

            const displayName = fullName.trim() || "User";
            const userEmail = user.email || "";

            bodyEl.innerHTML = `
              <div style="background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="bi bi-book"></i>
                  </div>
                  <div style="flex: 1;">
                    <h6 style="margin: 0; font-weight: 700; color: #333; font-size: 1.1rem;">${titre}</h6>
                    <p style="margin: 0.25rem 0 0 0; color: #6c757d; font-size: 0.9rem;">Exemplaire #${codeBarre}</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <i class="bi bi-hash" style="color: #667eea;"></i>
                  <span style="color: #6c757d; font-size: 0.9rem;">Numéro de prêt :</span>
                  <strong style="color: #333; font-size: 1rem;">#${loanId}</strong>
                </div>
              </div>
              
              <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                  <i class="bi bi-person-check" style="font-size: 24px; color: #667eea;"></i>
                  <h6 style="margin: 0; font-weight: 600; color: #333;">Successfully Reserved</h6>
                </div>
                <div style="padding: 0.75rem; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                  <p style="margin: 0; color: #2e7d32; font-size: 0.9rem;">
                    <i class="bi bi-check-circle-fill" style="margin-right: 0.5rem;"></i>
                    Your reservation has been recorded. You will receive a notification when the librarian validates your loan.
                  </p>
                </div>
              </div>
            `;
            modal.show();
          } catch (e) {
            // Re-enable the button on network error
            btn.disabled = false;
            btn.classList.remove("processing");
            btn.innerHTML = originalContent;
            alert("Network error. Please try again.");
          }
        });
      });

      // ADMIN flow: open user input modal
      document.querySelectorAll(".btn-reserve-admin").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (!adminModal) return;
          const exId = btn.getAttribute("data-ex-id");
          adminExIdInput.value = exId || "";
          adminUserIdInput.value = "";
          adminErrorBox.classList.add("d-none");
          adminErrorBox.textContent = "";
          // on mémorise le bouton cliqué pour retrouver la ligne plus tard
          adminExIdInput.setAttribute(
            "data-btn-selector",
            `.btn-reserve-admin[data-ex-id='${exId}']`
          );
          adminModal.show();
        });
      });

      if (adminConfirmBtn) {
        adminConfirmBtn.addEventListener("click", async (event) => {
          event.preventDefault();
          event.stopPropagation();
          
          const exId = adminExIdInput.value;
          const userId = adminUserIdInput.value;
          if (!exId || !userId) {
            adminErrorBox.textContent = "Please enter a user ID.";
            adminErrorBox.classList.remove("d-none");
            return;
          }

          // Disable the button during processing
          if (adminConfirmBtn.disabled || adminConfirmBtn.classList.contains("processing")) {
            return;
          }
          
          adminConfirmBtn.disabled = true;
          adminConfirmBtn.classList.add("processing");
          const originalAdminContent = adminConfirmBtn.innerHTML;
          adminConfirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Reserving...';
          adminErrorBox.classList.add("d-none");
          
          try {
            const params = new URLSearchParams({
              exemplaireId: exId,
              userId: userId,
            });
            const res = await fetch(
              "/api/loans/reserveForUser?" + params.toString(),
              { method: "POST" }
            );
            const data = await res.json();

            if (!res.ok || data.error) {
              // Re-enable the button on error
              adminConfirmBtn.disabled = false;
              adminConfirmBtn.classList.remove("processing");
              adminConfirmBtn.innerHTML = originalAdminContent;
              adminErrorBox.textContent =
                data.error || "Erreur lors de la réservation.";
              adminErrorBox.classList.remove("d-none");
              return;
            }

            adminModal.hide();

            const loanId = data.id;
            const exemplaire = data.exemplaire || {};
            const ressource = exemplaire.ressource || {};
            const user = data.user || {};

            const titre = ressource.titre || "Ressource inconnue";
            const codeBarre = exemplaire.codeBarre || exemplaire.id || exId;
            const realUserId = user.id || userId;
            const fullName = (
              (user.firstname || "") +
              " " +
              (user.lastname || "")
            ).trim();
            const email = user.email || "";
            const role = user.role || "USER";

            // Update the row (badge + buttons) as for a normal reservation
            const btnSelector =
              adminExIdInput.getAttribute("data-btn-selector") ||
              `.btn-reserve-admin[data-ex-id='${exId}']`;
            const rowBtn = document.querySelector(btnSelector);
            if (rowBtn) {
              const row = rowBtn.closest("tr");
              if (row) {
                const badge = row.querySelector("td:nth-child(4) .badge");
                if (badge) {
                  badge.classList.remove("badge-available");
                  badge.classList.add("badge-unavailable");
                  badge.textContent = "No";
                }
                // disable reservation buttons for this row
                const userBtn = row.querySelector(".btn-reserve");
                if (userBtn) {
                  userBtn.classList.remove("btn-primary");
                  userBtn.classList.add("btn-secondary", "disabled");
                  userBtn.setAttribute("aria-disabled", "true");
                  userBtn.disabled = true;
                  const span = userBtn.querySelector("span");
                  if (span) span.textContent = "Not available";
                }
                rowBtn.classList.add("disabled");
                rowBtn.setAttribute("aria-disabled", "true");
                rowBtn.disabled = true;
              }
            }

            const intro = `Reservation registered by an <strong>administrator</strong> for the user:`;
            const displayName = fullName || "(not provided)";
            const displayEmail = email || "(not provided)";

            bodyEl.innerHTML = `
              <div style="background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="bi bi-book"></i>
                  </div>
                  <div style="flex: 1;">
                    <h6 style="margin: 0; font-weight: 700; color: #333; font-size: 1.1rem;">${titre}</h6>
                    <p style="margin: 0.25rem 0 0 0; color: #6c757d; font-size: 0.9rem;">Exemplaire #${codeBarre}</p>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                  <i class="bi bi-hash" style="color: #667eea;"></i>
                  <span style="color: #6c757d; font-size: 0.9rem;">Numéro de prêt :</span>
                  <strong style="color: #333; font-size: 1rem;">#${loanId}</strong>
                </div>
              </div>
              
              <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                  <i class="bi bi-person-circle" style="font-size: 24px; color: #667eea;"></i>
                  <h6 style="margin: 0; font-weight: 600; color: #333;">User Information</h6>
                </div>
                <div style="display: grid; gap: 0.75rem;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <i class="bi bi-person" style="color: #667eea; width: 20px;"></i>
                    <div style="flex: 1;">
                      <span style="color: #6c757d; font-size: 0.85rem; display: block;">Full name</span>
                      <strong style="color: #333; font-size: 0.95rem;">${displayName}</strong>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <i class="bi bi-envelope" style="color: #667eea; width: 20px;"></i>
                    <div style="flex: 1;">
                      <span style="color: #6c757d; font-size: 0.85rem; display: block;">Email</span>
                      <strong style="color: #333; font-size: 0.95rem;">${displayEmail}</strong>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                    <i class="bi bi-shield-check" style="color: #667eea; width: 20px;"></i>
                    <div style="flex: 1; display: flex; align-items: center; justify-content: space-between;">
                      <div>
                        <span style="color: #6c757d; font-size: 0.85rem; display: block;">Role</span>
                        <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600;">${role}</span>
                      </div>
                      <span style="color: #6c757d; font-size: 0.85rem;">ID: ${realUserId}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            modal.show();
            
            // Re-enable the button after success
            adminConfirmBtn.disabled = false;
            adminConfirmBtn.classList.remove("processing");
            adminConfirmBtn.innerHTML = originalAdminContent;
          } catch (e) {
            // Re-enable the button on network error
            adminConfirmBtn.disabled = false;
            adminConfirmBtn.classList.remove("processing");
            adminConfirmBtn.innerHTML = originalAdminContent;
            adminErrorBox.textContent = "Network error. Please try again.";
            adminErrorBox.classList.remove("d-none");
          }
        });
      }
    });
  </script>
</body>

</html>