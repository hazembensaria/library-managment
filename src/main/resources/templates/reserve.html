<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Réserver un exemplaire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3d7ff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 14px 40px rgba(0,0,0,0.12);
            max-width: 540px;
            width: 100%;
        }
        .card-header {
            background: linear-gradient(135deg, #4a90e2 0%, #6c63ff 100%);
            color: #fff;
            border-radius: 16px 16px 0 0;
            padding: 22px;
        }
        .card-header h4 {
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-body {
            padding: 24px;
            background: #fff;
            border-radius: 0 0 16px 16px;
        }
        .form-label {
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4a90e2 0%, #6c63ff 100%);
            border: none;
            font-weight: 600;
        }
        .btn-primary:hover {
            opacity: 0.95;
        }
    </style>
</head>
<body>
<div class="card">
    <div class="card-header">
        <h4><span class="bi bi-bookmark-plus"></span> Réserver un exemplaire</h4>
    </div>
    <div class="card-body">
        <div class="alert alert-danger d-none" id="errorBox"></div>
        <form id="reserveForm" class="row g-3">
            <div class="col-12">
                <label class="form-label">Exemplaire ID</label>
                <input type="number" class="form-control" id="exemplaireId" required>
            </div>
            <div class="col-12 d-grid">
                <button type="submit" class="btn btn-primary btn-lg">
                    Réserver
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal succès -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Réservation réussie</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="successBody">
        <!-- contenu injecté en JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Pré-remplir le formulaire si on vient de /loans/reserve?exemplaireId=...&userId=...
    const params = new URLSearchParams(window.location.search);
    if (params.has('exemplaireId')) {
        document.getElementById('exemplaireId').value = params.get('exemplaireId');
    }

    const errorBox = document.getElementById('errorBox');
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    const successBody = document.getElementById('successBody');

    document.getElementById('reserveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        errorBox.classList.add('d-none');
        const exemplaireId = document.getElementById('exemplaireId').value;
        const query = new URLSearchParams({ exemplaireId });

        try {
            const res = await fetch('/api/loans/reserve?' + query.toString(), { method: 'POST' });
            const data = await res.json();

            if (!res.ok || data.error) {
                errorBox.textContent = data.error || 'Erreur lors de la réservation.';
                errorBox.classList.remove('d-none');
                return;
            }

            // Succès : préparer le contenu du modal
            const loanId = data.id;
            const exemplaire = data.exemplaire || {};
            const ressource = exemplaire.ressource || {};
            const titre = ressource.titre || 'Ressource inconnue';
            const codeBarre = exemplaire.codeBarre || exemplaire.id || exemplaireId;

            successBody.innerHTML = `
                <p class="mb-1">Le livre <strong>"${titre}"</strong> (exemplaire <strong>${codeBarre}</strong>) a été réservé.</p>
                <p class="text-muted mb-0">Numéro de prêt : <strong>${loanId}</strong></p>
            `;
            successModal.show();
        } catch (err) {
            errorBox.textContent = 'Erreur réseau. Veuillez réessayer.';
            errorBox.classList.remove('d-none');
        }
    });
</script>
</body>
</html>