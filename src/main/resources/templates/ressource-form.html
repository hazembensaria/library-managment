<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title
      th:text="${ressource.id == null ? 'New Resource' : 'Edit the Resource'}"
    >
      Ressource
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
      }

      body {
        background: #f5f7fa;
        min-height: 100vh;
        padding: 2rem 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .form-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .top-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 1rem;
      }

      .form-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      .form-header {
        background: #4a90e2;
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .form-header h2 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .form-header i {
        font-size: 2rem;
      }

      .form-body {
        padding: 2.5rem;
      }

      .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-title i {
        color: var(--primary-color);
        font-size: 1.5rem;
      }

      .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-label i {
        color: var(--primary-color);
      }

      .form-control,
      .form-select,
      .form-textarea {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s;
        font-size: 1rem;
      }

      .form-control:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }

      .form-textarea {
        min-height: 120px;
        resize: vertical;
      }

      .file-upload-wrapper {
        position: relative;
        display: block;
      }

      .file-upload-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 1.5rem;
        border: 2px dashed #d0d0d0;
        border-radius: 10px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .file-upload-label:hover {
        border-color: var(--primary-color);
        background: #e7f1ff;
      }

      .file-upload-label i {
        font-size: 2rem;
        color: var(--primary-color);
      }

      .file-name {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #28a745;
        font-weight: 600;
      }

      .current-file-display {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .current-file-display img {
        max-width: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .current-file-display a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .current-file-display a:hover {
        text-decoration: underline;
      }

      .btn-submit {
        background: #4a90e2;
        border: none;
        color: white;
        padding: 1rem 3rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1.1rem;
        transition: transform 0.3s, box-shadow 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4);
        background: #357abd;
      }

      .btn-cancel {
        background: #6c757d;
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-cancel:hover {
        background: #5a6268;
        color: white;
        transform: translateY(-2px);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #f0f0f0;
      }

      .alert-info {
        background: #e7f1ff;
        border: 2px solid #b3d7ff;
        border-radius: 10px;
        padding: 1rem;
        color: #004085;
      }

      @media (max-width: 768px) {
        .form-body {
          padding: 1.5rem;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn-submit,
        .btn-cancel {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div class="form-card">
        <div class="form-header">
          <h2>
            <i
              th:class="${ressource.id == null ? 'bi bi-plus-circle-fill' : 'bi bi-pencil-square'}"
            ></i>
            <span
              th:text="${ressource.id == null ? 'New Ressource' : 'Edit Ressource'}"
            ></span>
          </h2>
        </div>

        <div class="form-body">
          <form
            th:action="@{/ressources/save}"
            th:object="${ressource}"
            method="post"
            enctype="multipart/form-data"
          >
            <input type="hidden" th:field="*{id}" />

            <!-- Section: Informations principales -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="bi bi-info-circle-fill"></i>
                Main information
              </h3>

              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-card-heading"></i>
                  Resource Title
                </label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{titre}"
                  placeholder="Enter the full title"
                />
                <div
                  class="text-danger"
                  th:if="${#fields.hasErrors('titre')}"
                  th:errors="*{titre}"
                ></div>
              </div>

              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-person-fill"></i>
                  Author
                </label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{auteur}"
                  placeholder="Author's name"
                />
                <div
                  th:if="${#fields.hasErrors('auteur')}"
                  th:errors="*{auteur}"
                ></div>
              </div>
              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-calendar-event-fill"></i>
                  Publish date
                </label>
                <input
                  type="date"
                  class="form-control"
                  th:field="*{publishDate}"
                />
                <div
                  class="text-danger"
                  th:if="${#fields.hasErrors('publishDate')}"
                  th:errors="*{publishDate}"
                ></div>
              </div>

              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-tag-fill"></i>
                  Resource type
                </label>
                <select
                  class="form-select"
                  th:field="*{typeRessource}"
                  id="typeRessource"
                >
                  <option value="LIVRE">üìö BOOK</option>
                  <option value="DOCUMENT">üìÑ Document</option>
                  <option value="CD">üíø CD</option>
                  <option value="DVD">üìÄ DVD</option>
                  <option value="REVUE">üì∞ Review</option>
                </select>
              </div>

              <!-- NOUVEAU CHAMP: Cat√©gorie -->
              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-tags-fill"></i>
                  Cat√©gorie
                </label>
                <select
                  class="form-select"
                  th:field="*{categorie}"
                  id="categorie"
                >
                  <option value="ROMAN">üìñ Novel</option>
                  <option value="DETECTIVE">üîç Detective</option>
                  <option value="SCIENCE_FICTION">üöÄ Science Fiction</option>
                  <option value="FANTASY">üßô Fantasy</option>
                  <option value="HISTORICAL">üèõÔ∏è Historical</option>
                  <option value="BIOGRAPHY">üë§ Biography</option>
                  <option value="POETRY">‚úçÔ∏è Poetry</option>
                  <option value="THEATER">üé≠ Theater</option>
                  <option value="COOKING">üë®‚Äçüç≥ Cooking</option>
                  <option value="TRAVEL">‚úàÔ∏è Travel</option>
                  <option value="SPORTS">‚öΩ Sports</option>
                  <option value="MUSIC">üéµ Music</option>
                  <option value="CINEMA">üé¨ Cinema</option>
                  <option value="ART">üé® Art</option>
                  <option value="PHILOSOPHY">ü§î Philosophy</option>
                  <option value="PSYCHOLOGY">üß† Psychology</option>
                  <option value="ECONOMICS">üìà Economics</option>
                  <option value="COMPUTER_SCIENCE">üíª Computer Science</option>
                  <option value="LANGUAGE">üó£Ô∏è Language</option>
                </select>
              </div>

              <!-- Description -->
              <div class="mb-4">
                <label class="form-label">
                  <i class="bi bi-text-paragraph"></i>
                  Description
                </label>
                <textarea
                  class="form-control form-textarea"
                  th:field="*{description}"
                  placeholder="Entrez une description d√©taill√©e de la ressource..."
                  rows="4"
                ></textarea>
                <div
                  th:if="${#fields.hasErrors('description')}"
                  th:errors="*{description}"
                ></div>
                <small class="text-muted"
                  >Describe the content, themes, and main features. Main
                  features</small
                >
              </div>
            </div>

            <!-- Section: Couverture -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="bi bi-image-fill"></i>
                Cover image
              </h3>

              <div
                th:if="*{id} != null and *{coverPath} != null"
                class="current-file-display"
              >
                <p class="fw-bold mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  Current Cover :
                </p>
                <img
                  th:src="@{/ressources/cover/{id}(id=*{id})}"
                  alt="Couverture"
                  class="img-fluid"
                />
              </div>

              <label class="form-label">
                <i class="bi bi-cloud-upload"></i>
                <span
                  th:text="*{id} == null ? 'T√©l√©charger la couverture' : 'Remplacer la couverture'"
                ></span>
              </label>
              <div class="file-upload-wrapper">
                <input
                  type="file"
                  name="coverFile"
                  accept="image/*"
                  class="file-upload-input"
                  id="coverFile"
                />
                <label for="coverFile" class="file-upload-label">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <div>
                    <div class="fw-bold">Click to select an image</div>
                    <small class="text-muted">JPG, PNG, GIF (max 5 MB)</small>
                  </div>
                </label>
                <div id="coverFileName" class="file-name"></div>
              </div>
              <div id="coverError" class="text-danger mt-2"></div>
              <div class="alert alert-info mt-2" th:if="*{id} != null">
                <i class="bi bi-info-circle"></i>
                Leave blank to keep the current cover
              </div>
            </div>

            <!-- Section: Preview (conditionnelle) -->
            <div class="form-section" id="previewSection">
              <h3 class="section-title">
                <i class="bi bi-file-earmark-text-fill"></i>
                Content overview
              </h3>

              <div
                th:if="*{id} != null and *{previewPath} != null"
                class="current-file-display"
              >
                <p class="fw-bold mb-2">
                  <i class="bi bi-check-circle-fill text-success"></i>
                  Current overview :
                </p>
                <a
                  th:href="@{/ressources/preview/{id}(id=*{id})}"
                  target="_blank"
                >
                  <i class="bi bi-eye"></i>
                  View the preview
                </a>
              </div>

              <label class="form-label">
                <i class="bi bi-cloud-upload"></i>
                <span
                  th:text="*{id} == null ? 'Download a preview' : 'Replace the preview'"
                ></span>
              </label>
              <div class="file-upload-wrapper">
                <input
                  type="file"
                  name="previewFile"
                  accept="application/pdf,image/*"
                  class="file-upload-input"
                  id="previewFile"
                />
                <label for="previewFile" class="file-upload-label">
                  <i class="bi bi-file-earmark-pdf"></i>
                  <div>
                    <div class="fw-bold">Select a PDF file or images</div>
                    <small class="text-muted"
                      >First pages of the document</small
                    >
                  </div>
                </label>
                <div id="previewFileName" class="file-name"></div>
              </div>
              <div id="previewError" class="text-danger mt-2"></div>
              <div class="alert alert-info mt-2">
                <i class="bi bi-lightbulb"></i>
                The preview allows users to view the first few pages before
                borrowing.
              </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
              <a href="/ressources" class="btn-cancel">
                <i class="bi bi-x-circle"></i>
                Cancel
              </a>
              <button type="submit" class="btn-submit">
                <i class="bi bi-check-circle"></i>
                <span
                  th:text="${ressource.id == null ? 'Create the resource' : 'Save changes'}"
                ></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Mets des valeurs <= √† la limite serveur/proxy, sinon tu auras encore 413.
      // Test conseill√©: 1MB. Puis ajuste.
      const MAX_COVER = 1 * 1024 * 1024; // 1MB
      const MAX_PREVIEW = 1 * 1024 * 1024; // 1MB
      const MAX_TOTAL = 1 * 1024 * 1024; // 1MB total cover+preview (tr√®s important)

      function setText(id, msg) {
        const el = document.getElementById(id);
        if (el) el.textContent = msg || "";
      }

      function formatMB(bytes) {
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      function clearFile(inputId, nameId) {
        const input = document.getElementById(inputId);
        if (input) input.value = "";
        setText(nameId, "");
      }

      function validateFile(inputId, errorId, maxBytes, label) {
        setText(errorId, "");
        const input = document.getElementById(inputId);
        const f = input?.files?.[0];
        if (!f) return true;

        if (f.size > maxBytes) {
          setText(
            errorId,
            `${label} trop volumineux (max ${formatMB(maxBytes)}).`
          );
          input.value = ""; // emp√™che l'envoi
          return false;
        }
        return true;
      }

      function validateTotal() {
        // on met un message sur previewError (ou cr√©e un message global si tu veux)
        setText("previewError", "");

        const cover = document.getElementById("coverFile")?.files?.[0];
        const preview = document.getElementById("previewFile")?.files?.[0];
        const total = (cover?.size || 0) + (preview?.size || 0);

        if (total > MAX_TOTAL) {
          setText(
            "previewError",
            `Total fichiers trop volumineux (max ${formatMB(MAX_TOTAL)}).`
          );
          return false;
        }
        return true;
      }

      function togglePreviewField() {
        const type = document.getElementById("typeRessource")?.value;
        const previewSection = document.getElementById("previewSection");

        if (type === "LIVRE" || type === "DOCUMENT") {
          previewSection.style.display = "block";
        } else {
          previewSection.style.display = "none";
          // Tr√®s important : si on cache, on vide le fichier pour qu'il ne parte pas au submit
          clearFile("previewFile", "previewFileName");
          setText("previewError", "");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Init affichage preview
        document
          .getElementById("typeRessource")
          ?.addEventListener("change", togglePreviewField);
        togglePreviewField();

        // Cover: nom + validation
        document
          .getElementById("coverFile")
          ?.addEventListener("change", (e) => {
            const f = e.target.files?.[0];
            setText("coverFileName", f ? "‚úì " + f.name : "");
            validateFile("coverFile", "coverError", MAX_COVER, "Couverture");
            validateTotal();
          });

        // Preview: nom + validation
        document
          .getElementById("previewFile")
          ?.addEventListener("change", (e) => {
            const f = e.target.files?.[0];
            setText("previewFileName", f ? "‚úì " + f.name : "");
            validateFile("previewFile", "previewError", MAX_PREVIEW, "Preview");
            validateTotal();
          });

        // Bloquer l'envoi si invalide (sinon tu peux encore tomber sur 413)
        document
          .getElementById("ressourceForm")
          ?.addEventListener("submit", (e) => {
            const okCover = validateFile(
              "coverFile",
              "coverError",
              MAX_COVER,
              "Couverture"
            );
            const okPreview = validateFile(
              "previewFile",
              "previewError",
              MAX_PREVIEW,
              "Preview"
            );
            const okTotal = validateTotal();

            if (!(okCover && okPreview && okTotal)) {
              e.preventDefault();
            }
          });
      });
    </script>
  </body>
</html>
