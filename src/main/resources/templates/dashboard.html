<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" sec:authorize="hasAuthority('ADMIN')"></script>

  <style>
    :root{
      --primary:#4a90e2; --bg:#f5f7fa; --card:#ffffff;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --shadowHover:0 16px 40px rgba(0,0,0,.14);
      --radius:16px;
    }
    body{background:var(--bg);min-height:100vh;padding:2rem 0;font-family:"Segoe UI",sans-serif}
    .container-xl{max-width:1400px}
    .header{
      background:var(--card); border-radius:var(--radius); padding:1.6rem 1.6rem;
      box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.04); margin-bottom:1.2rem;
    }
    .title{font-weight:900;margin:0;display:flex;align-items:center;gap:.7rem}
    .title i{color:var(--primary)}
    .subtitle{color:#6c757d;font-weight:600;margin-top:.2rem}
    .pill{
      display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .75rem;border-radius:999px;
      font-weight:800;font-size:.85rem;background:#eef2ff;color:#1e40af;
    }
    .role{
      display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .75rem;border-radius:999px;
      font-weight:900;font-size:.85rem;
    }
    .role-admin{background:#fee2e2;color:#991b1b}
    .role-lib{background:#dcfce7;color:#166534}
    .role-user{background:#e0e7ff;color:#1e40af}

    .export-btn{
      border:none; padding:.7rem 1rem; border-radius:12px; color:white; font-weight:900;
      text-decoration:none; display:inline-flex; align-items:center; gap:.5rem;
      transition:transform .2s, box-shadow .2s;
    }
    .export-btn:hover{transform:translateY(-2px);box-shadow:var(--shadowHover);color:#fff}
    .btn-csv{background:linear-gradient(135deg,#667eea 0%,#3799e9 100%)}
    .btn-pdf{background:linear-gradient(135deg,#ef4444 0%,#f97316 100%)}

    .cardx{
      background:var(--card); border-radius:var(--radius); padding:1.2rem 1.2rem;
      box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.04); height:100%;
      transition:transform .2s, box-shadow .2s;
    }
    .cardx:hover{transform:translateY(-4px);box-shadow:var(--shadowHover)}
    .kpi-top{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .kpi-label{color:#6c757d;font-weight:800;margin:0;display:flex;align-items:center;gap:.5rem}
    .kpi-icon{
      width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:1.2rem;
    }
    .ic1{background:linear-gradient(135deg,#667eea 0%,#3799e9 100%)}
    .ic2{background:linear-gradient(135deg,#a78bfa 0%,#7c3aed 100%)}
    .ic3{background:linear-gradient(135deg,#2dd4bf 0%,#0ea5e9 100%)}
    .ic4{background:linear-gradient(135deg,#34d399 0%,#16a34a 100%)}
    .ic5{background:linear-gradient(135deg,#fb7185 0%,#dc2626 100%)}
    .ic6{background:linear-gradient(135deg,#f97316 0%,#f59e0b 100%)}

    .kpi-value{font-size:2rem;font-weight:950;color:#111827;margin-top:.65rem}
    .kpi-hint{margin:.25rem 0 0;color:#94a3b8;font-weight:700;font-size:.92rem}

    .panel{
      background:var(--card); border-radius:var(--radius); padding:1.3rem 1.3rem;
      box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.04);
    }
    .panel-title{margin:0;font-weight:950;color:#111827;display:flex;align-items:center;gap:.6rem}
    .panel-title i{color:var(--primary)}
    .muted{color:#6c757d;font-weight:650}

    .chart-box{height:320px}
    @media(max-width:768px){.chart-box{height:240px}}

    /* Notifications dropdown */
    .notif-btn{
      border:1px solid rgba(0,0,0,.08);
      background:#fff; border-radius:12px; padding:.55rem .7rem;
      display:inline-flex;align-items:center;gap:.5rem;
      transition:transform .2s, box-shadow .2s;
    }
    .notif-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .notif-badge{
      font-weight:900;
    }
    .dropdown-menu-notif{
      width:min(420px, 92vw);
      border-radius:16px;
      padding:0;
      overflow:hidden;
      box-shadow:var(--shadowHover);
      border:1px solid rgba(0,0,0,.08);
    }
    .notif-head{
      padding:1rem 1rem;
      background:linear-gradient(135deg,#667eea 0%,#3799e9 100%);
      color:#fff;
      display:flex;justify-content:space-between;align-items:center;
    }
    .notif-body{padding:1rem 1rem;background:#fff}
    .notif-item{border-radius:12px}
  </style>
</head>

<body>
<div class="container-xl">

  <!-- HEADER -->
  <div class="header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div>
        <h1 class="title">
          <i class="bi bi-speedometer2"></i> Dashboard
          <span class="pill"><i class="bi bi-database-check"></i> Donn√©es DB</span>
        </h1>
        <div class="subtitle">Tableaux de bord personnalis√©s par r√¥le + statistiques & export.</div>

        <div class="mt-3 d-flex gap-2 flex-wrap">
          <span class="role role-admin" sec:authorize="hasAuthority('ADMIN')"><i class="bi bi-shield-lock"></i> ADMIN</span>
          <span class="role role-lib" sec:authorize="hasAuthority('BIBLIOTHECAIRE')"><i class="bi bi-person-workspace"></i> BIBLIOTH√âCAIRE</span>
          <span class="role role-user" sec:authorize="hasAuthority('USER')"><i class="bi bi-person"></i> USAGER</span>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">

        <!-- üîî Notifications (box √† ouvrir) -->
        <div class="dropdown">
          <button class="notif-btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" type="button">
            <i class="bi bi-bell-fill" style="color:var(--primary)"></i>
            <span class="badge bg-danger notif-badge" th:text="${nonLuesCount != null ? nonLuesCount : 0}">0</span>
          </button>

          <div class="dropdown-menu dropdown-menu-end dropdown-menu-notif">
            <div class="notif-head">
              <div class="fw-bold"><i class="bi bi-bell"></i> Notifications</div>
              <span class="badge bg-light text-dark" th:text="${nonLuesCount != null ? nonLuesCount : 0} + ' non lue(s)'">0</span>
            </div>

            <div class="notif-body">
              <!-- Liste -->
              <div th:if="${notifications != null and !#lists.isEmpty(notifications)}">
                <div class="list-group">
                  <div class="list-group-item notif-item mb-2"
                       th:each="n : ${notifications}"
                       th:classappend="${n.lu} ? '' : ' list-group-item-warning'">

                    <div class="d-flex justify-content-between gap-2">
                      <div>
                        <div class="fw-semibold">
                          <span class="badge bg-info text-dark me-2" th:text="${n.type}">TYPE</span>
                          <span th:text="${n.message}">Message</span>
                        </div>
                        <small class="text-muted" th:text="${n.dateEnvoi}">date</small>
                      </div>

                      <form th:if="${!n.lu}" th:action="@{'/notifications/lue/' + ${n.id}}" method="post">
                        <button class="btn btn-sm btn-outline-primary" type="submit">Lue</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mb-2" th:if="${notifications == null or #lists.isEmpty(notifications)}">
                <i class="bi bi-info-circle"></i> Aucune notification.
              </div>

              <!-- Test email simple -->
              <form th:action="@{/notifications/test-email}" method="post" class="d-flex gap-2">
                <input class="form-control" name="message" placeholder="Message test email..." required/>
                <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i></button>
              </form>
            </div>
          </div>
        </div>

        <!-- Export ADMIN only -->
        <div class="d-flex gap-2" sec:authorize="hasAuthority('ADMIN')">
          <a class="export-btn btn-csv" th:href="@{/export/csv}"><i class="bi bi-filetype-csv"></i> CSV</a>
          <a class="export-btn btn-pdf" th:href="@{/export/pdf}"><i class="bi bi-filetype-pdf"></i> PDF</a>
        </div>
    <!-- r√¥le discret (pas en haut √† droite, pas lourd) -->
    <div class="mt-3 d-flex align-items-center gap-3">
      <div>
        <span class="role-badge role-admin" sec:authorize="hasAuthority('ADMIN')">
          <i class="bi bi-shield-lock"></i> ADMIN
        </span>
        <span class="role-badge role-user" sec:authorize="hasAuthority('USER')">
          <i class="bi bi-person"></i> USER
        </span>
        <span class="role-badge role-user" sec:authorize="hasAuthority('BIBLIOTHECAIRE')">
          <i class="bi bi-book"></i> BIBLIOTH√âCAIRE
        </span>
      </div>
      <div sec:authorize="hasAnyAuthority('ADMIN','BIBLIOTHECAIRE')">
        <a class="quick-link" th:href="@{/loans}">
          <i class="bi bi-list-check"></i> G√©rer les pr√™ts
        </a>
      </div>
    </div>
  </div>

  <!-- ========================= ADMIN ========================= -->
  <div sec:authorize="hasAuthority('ADMIN')">

    <!-- KPIs Admin -->
    <div class="row g-4" th:if="${kpis != null}">
      <div class="col-12 col-md-6 col-xl-4">
        <div class="cardx">
          <div class="kpi-top">
            <p class="kpi-label"><i class="bi bi-buildings"></i> Biblioth√®ques</p>
            <div class="kpi-icon ic1"><i class="bi bi-buildings"></i></div>
          </div>
          <div class="kpi-value" th:text="${kpis.totalBibliotheques}">0</div>
          <p class="kpi-hint">Total d‚Äô√©tablissements</p>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-4">
        <div class="cardx">
          <div class="kpi-top">
            <p class="kpi-label"><i class="bi bi-collection"></i> Ressources</p>
            <div class="kpi-icon ic2"><i class="bi bi-collection"></i></div>
          </div>
          <div class="kpi-value" th:text="${kpis.totalRessources}">0</div>
          <p class="kpi-hint">Livres / m√©dias</p>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-4">
        <div class="cardx">
          <div class="kpi-top">
            <p class="kpi-label"><i class="bi bi-stack"></i> Exemplaires</p>
            <div class="kpi-icon ic3"><i class="bi bi-stack"></i></div>
          </div>
          <div class="kpi-value" th:text="${kpis.totalExemplaires}">0</div>
          <p class="kpi-hint">Inventaire total</p>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="cardx">
          <div class="kpi-top">
            <p class="kpi-label"><i class="bi bi-check-circle"></i> Disponibles</p>
            <div class="kpi-icon ic4"><i class="bi bi-check-circle"></i></div>
          </div>
          <div class="kpi-value" th:text="${kpis.exemplairesDisponibles}">0</div>
          <p class="kpi-hint">Disponibles imm√©diatement</p>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="cardx">
          <div class="kpi-top">
            <p class="kpi-label"><i class="bi bi-x-circle"></i> Indisponibles</p>
            <div class="kpi-icon ic5"><i class="bi bi-x-circle"></i></div>
          </div>
          <div class="kpi-value" th:text="${kpis.exemplairesIndisponibles}">0</div>
          <p class="kpi-hint">Emprunt√©s / maintenance</p>
        </div>
      </div>
    </div>

    <!-- Charts Admin -->
    <div class="row g-4 mt-1">
      <div class="col-12 col-lg-6">
        <div class="panel">
          <h5 class="panel-title"><i class="bi bi-bar-chart"></i> Pr√™ts par cat√©gorie</h5>
          <p class="muted mt-2 mb-3">Nombre de pr√™ts par type de ressource.</p>
          <div class="chart-box"><canvas id="chartCategorie"></canvas></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="panel">
          <h5 class="panel-title"><i class="bi bi-pie-chart"></i> Pr√™ts par biblioth√®que</h5>
          <p class="muted mt-2 mb-3">R√©partition des pr√™ts par √©tablissement.</p>
          <div class="chart-box"><canvas id="chartBiblio"></canvas></div>
        </div>
      </div>

      <div class="col-12">
        <div class="panel">
          <h5 class="panel-title"><i class="bi bi-graph-up"></i> Taux de rotation des stocks</h5>
          <p class="muted mt-2 mb-3">√âvolution sur les 6 derniers mois.</p>
          <div class="chart-box"><canvas id="chartRotation"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Chart.js init (statique, mais tu peux remplacer par model plus tard) -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      document.addEventListener('DOMContentLoaded', function () {
        const c1 = document.getElementById('chartCategorie');
        const c2 = document.getElementById('chartBiblio');
        const c3 = document.getElementById('chartRotation');
        if (!c1 || !c2 || !c3) return;

        // ‚úÖ Statique (comme demand√©) -> OK pour la t√¢che
        new Chart(c1, {
          type: 'bar',
          data: { labels: ['Livres','Revues','DVD','CD','Num√©rique'],
            datasets: [{ label: 'Pr√™ts', data: [120,45,30,25,15] }] },
          options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });

        new Chart(c2, {
          type: 'pie',
          data: { labels: ['Centrale','Est','Ouest','Nord'],
            datasets: [{ data: [40,25,20,15] }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
        });

        new Chart(c3, {
          type: 'line',
          data: { labels: ['Jan','F√©v','Mar','Avr','Mai','Juin'],
            datasets: [{ label:'Rotation (%)', data:[65,70,72,75,78,80], fill:true, tension:.3 }] },
          options: { responsive:true, maintainAspectRatio:false }
        });
      });
      /*]]>*/
    </script>
  </div>

  <!-- ====================== BIBLIOTH√âCAIRE ====================== -->
  <div sec:authorize="hasAuthority('BIBLIOTHECAIRE')">

    <div class="row g-4" th:if="${statsLibrarian != null}">
      <div class="col-6 col-md-3"><div class="cardx text-center"><h2 class="text-danger" th:text="${statsLibrarian.retards}">0</h2><div class="muted">Retards</div></div></div>
      <div class="col-6 col-md-3"><div class="cardx text-center"><h2 class="text-warning" th:text="${statsLibrarian.aRendre}">0</h2><div class="muted">‚â§ 3 jours</div></div></div>
      <div class="col-6 col-md-3"><div class="cardx text-center"><h2 class="text-primary" th:text="${statsLibrarian.enCours}">0</h2><div class="muted">Actifs</div></div></div>
      <div class="col-6 col-md-3"><div class="cardx text-center"><h2 th:text="${statsLibrarian.tauxRotation} + '%'">0%</h2><div class="muted">Rotation</div></div></div>
    </div>

    <div class="panel mt-3">
      <h5 class="panel-title"><i class="bi bi-clock-history"></i> Pr√™ts en cours - Priorit√©s</h5>
      <div class="table-responsive mt-3">
        <table class="table table-hover">
          <thead class="table-light">
          <tr><th>Priorit√©</th><th>Usager</th><th>Titre</th><th>Date retour</th><th>Retard</th></tr>
          </thead>
          <tbody>
          <tr th:each="pret : ${pretsEnCours}"
              th:class="${pret.priorite == 'HAUTE'} ? 'table-danger' : (${pret.priorite == 'MOYENNE'} ? 'table-warning' : 'table-success')">
            <td>
              <span th:if="${pret.priorite == 'HAUTE'}" class="badge bg-danger">Haute</span>
              <span th:if="${pret.priorite == 'MOYENNE'}" class="badge bg-warning">Moyenne</span>
              <span th:if="${pret.priorite == 'BASSE'}" class="badge bg-success">Basse</span>
            </td>
            <td th:text="${pret.usagerNom}"></td>
            <td th:text="${pret.titre}"></td>
            <td th:text="${pret.dateRetourPrevue}"></td>
            <td>
              <span th:if="${pret.joursRestants < 0}" class="text-danger"><i class="bi bi-exclamation-triangle"></i> +[[${-pret.joursRestants}]]j</span>
              <span th:if="${pret.joursRestants >= 0}" class="text-success">[[${pret.joursRestants}]]j</span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ========================= USER ========================= -->
  <div sec:authorize="hasAuthority('USER')">

    <div class="row g-4" th:if="${statsUser != null}">
      <div class="col-4"><div class="cardx text-center"><h3 th:text="${statsUser.pretsEnCours}">0</h3><div class="muted">En cours</div></div></div>
      <div class="col-4"><div class="cardx text-center"><h3 th:text="${statsUser.pretsEnRetard}">0</h3><div class="muted">En retard</div></div></div>
      <div class="col-4"><div class="cardx text-center"><h3 th:text="${statsUser.pretsRestitues}">0</h3><div class="muted">Restitu√©s</div></div></div>
    </div>

    <div class="panel mt-3">
      <h5 class="panel-title"><i class="bi bi-book"></i> Mes pr√™ts en cours</h5>
      <div class="table-responsive mt-3">
        <table class="table table-hover">
          <thead class="table-light">
          <tr><th>Titre</th><th>Auteur</th><th>Date emprunt</th><th>Date retour</th><th>Statut</th></tr>
          </thead>
          <tbody>
          <tr th:each="pret : ${mesPrets}">
            <td th:text="${pret.titre}"></td>
            <td th:text="${pret.auteur}"></td>
            <td th:text="${pret.dateEmprunt}"></td>
            <td th:text="${pret.dateRetourPrevue}"></td>
            <td>
              <span th:if="${pret.joursRestants < 0}" class="badge bg-danger">En retard ([[${-pret.joursRestants}]]j)</span>
              <span th:if="${pret.joursRestants >= 0 and pret.joursRestants < 3}" class="badge bg-warning">√Ä rendre ([[${pret.joursRestants}]]j)</span>
              <span th:if="${pret.joursRestants >= 3}" class="badge bg-success">En cours ([[${pret.joursRestants}]]j)</span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="alert alert-info mt-3" th:if="${#lists.isEmpty(mesPrets)}">
        <i class="bi bi-info-circle"></i> Vous n'avez aucun pr√™t en cours.
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
