<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Statistiques</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"/>

  <style>
    :root{
      --primary-color:#4a90e2;
      --secondary-color:#6c757d;
      --success-color:#28a745;
      --danger-color:#dc3545;
      --bg:#f5f7fa;
    }

    body{
      background: var(--bg);
      min-height: 100vh;
      padding: 2rem 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .main-container{
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .header-section{
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    .header-section h1{
      color:#333;
      font-weight:800;
      margin:0;
      display:flex;
      align-items:center;
      gap:1rem;
    }
    .header-section h1 i{ color: var(--primary-color); }

    .subtitle{
      margin-top: .5rem;
      color:#6c757d;
      font-weight:500;
    }

    .export-btn{
      border:none;
      padding:.75rem 1.25rem;
      border-radius:10px;
      color:white;
      font-weight:700;
      transition: transform .2s, box-shadow .2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:.6rem;
      white-space:nowrap;
    }

    .export-btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      color:white;
    }

    .btn-csv{ background: linear-gradient(135deg, #667eea 0%, #3799e9 100%); }
    .btn-pdf{ background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); }

    .mini-pill{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .75rem;
      border-radius: 999px;
      font-size:.85rem;
      font-weight:700;
      background:#eef2ff;
      color:#1e40af;
    }

    .kpi-card{
      background:white;
      border-radius:15px;
      padding:1.3rem 1.3rem;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.04);
      height:100%;
      transition: transform .2s, box-shadow .2s;
    }

    .kpi-card:hover{
      transform: translateY(-4px);
      box-shadow: 0 15px 35px rgba(0,0,0,.12);
    }

    .kpi-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }

    .kpi-label{
      color:#6c757d;
      font-weight:700;
      margin:0;
      display:flex;
      align-items:center;
      gap:.6rem;
    }

    .kpi-icon{
      width:42px;
      height:42px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      color:white;
    }
    .icon-primary{ background: linear-gradient(135deg, #667eea 0%, #3799e9 100%); }
    .icon-success{ background: linear-gradient(135deg, #34d399 0%, #16a34a 100%); }
    .icon-danger{ background: linear-gradient(135deg, #fb7185 0%, #dc2626 100%); }
    .icon-purple{ background: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%); }
    .icon-teal{ background: linear-gradient(135deg, #2dd4bf 0%, #0ea5e9 100%); }

    .kpi-value{
      font-size: 2rem;
      font-weight: 900;
      color:#111827;
      margin-top:.7rem;
      letter-spacing:.3px;
    }

    .kpi-hint{
      margin: .2rem 0 0;
      color:#94a3b8;
      font-size: .9rem;
      font-weight:600;
    }

    .panel{
      background:white;
      border-radius:15px;
      padding:1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.04);
    }

    .panel-title{
      margin:0;
      font-weight:800;
      color:#111827;
      display:flex;
      align-items:center;
      gap:.7rem;
    }
    .panel-title i{ color: var(--primary-color); }

    .muted{ color:#6c757d; font-weight:600; }

    .role-badge{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .75rem;
      border-radius:999px;
      font-weight:800;
      font-size:.85rem;
      background:#f1f5f9;
      color:#0f172a;
    }

    .role-admin{ background:#fee2e2; color:#991b1b; }
    .role-user{ background:#e0e7ff; color:#1e40af; }

    .quick-link{
      text-decoration:none;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:.6rem;
      padding:.9rem 1rem;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid rgba(0,0,0,.06);
      color:#111827;
      transition: transform .2s, box-shadow .2s;
    }
    .quick-link:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      color:#111827;
    }

    .quick-link i{ color: var(--primary-color); font-size:1.1rem; }

    @media (max-width: 768px){
      .header-section{ padding: 1.4rem; }
    }
  </style>
</head>

<body>
<div class="main-container">

  <!-- HEADER -->
  <div class="header-section">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1>
          <i class="bi bi-speedometer2"></i>
          Dashboard
          <span class="mini-pill">
            <i class="bi bi-database-check"></i> Données DB
          </span>
        </h1>
        <div class="subtitle">
          Indicateurs clés (Bibliothèques, Ressources, Exemplaires, Disponibilité).
        </div>
      </div>

      <!-- ✅ SEULEMENT 2 BOUTONS, ADMIN ONLY -->
      <div class="d-flex gap-2" sec:authorize="hasAuthority('ADMIN')">
        <a class="export-btn btn-csv" th:href="@{/export/csv}">
          <i class="bi bi-filetype-csv"></i> Export CSV
        </a>
        <a class="export-btn btn-pdf" th:href="@{/export/pdf}">
          <i class="bi bi-filetype-pdf"></i> Export PDF
        </a>
      </div>
    </div>

    <!-- rôle discret (pas en haut à droite, pas lourd) -->
    <div class="mt-3">
      <span class="role-badge role-admin" sec:authorize="hasAuthority('ADMIN')">
        <i class="bi bi-shield-lock"></i> ADMIN
      </span>
      <span class="role-badge role-user" sec:authorize="hasAuthority('USER')">
        <i class="bi bi-person"></i> USER
      </span>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row g-4" th:if="${kpis != null}">

    <div class="col-12 col-md-6 col-xl-4">
      <div class="kpi-card">
        <div class="kpi-top">
          <p class="kpi-label"><i class="bi bi-buildings"></i> Total bibliothèques</p>
          <div class="kpi-icon icon-primary"><i class="bi bi-buildings"></i></div>
        </div>
        <div class="kpi-value" th:text="${kpis.totalBibliotheques}">0</div>
        <p class="kpi-hint">Nombre total d’établissements enregistrés</p>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="kpi-card">
        <div class="kpi-top">
          <p class="kpi-label"><i class="bi bi-collection"></i> Total ressources</p>
          <div class="kpi-icon icon-purple"><i class="bi bi-collection"></i></div>
        </div>
        <div class="kpi-value" th:text="${kpis.totalRessources}">0</div>
        <p class="kpi-hint">Livres / documents / médias</p>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-4">
      <div class="kpi-card">
        <div class="kpi-top">
          <p class="kpi-label"><i class="bi bi-stack"></i> Total exemplaires</p>
          <div class="kpi-icon icon-teal"><i class="bi bi-stack"></i></div>
        </div>
        <div class="kpi-value" th:text="${kpis.totalExemplaires}">0</div>
        <p class="kpi-hint">Copies physiques en inventaire</p>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="kpi-card">
        <div class="kpi-top">
          <p class="kpi-label"><i class="bi bi-check-circle"></i> Exemplaires disponibles</p>
          <div class="kpi-icon icon-success"><i class="bi bi-check-circle"></i></div>
        </div>
        <div class="kpi-value" th:text="${kpis.exemplairesDisponibles}">0</div>
        <p class="kpi-hint">Disponibles immédiatement</p>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="kpi-card">
        <div class="kpi-top">
          <p class="kpi-label"><i class="bi bi-x-circle"></i> Exemplaires indisponibles</p>
          <div class="kpi-icon icon-danger"><i class="bi bi-x-circle"></i></div>
        </div>
        <div class="kpi-value" th:text="${kpis.exemplairesIndisponibles}">0</div>
        <p class="kpi-hint">Empruntés / en maintenance / hors service</p>
      </div>
    </div>

  </div>

  <!-- PANELS BAS (utile, pas du texte inutile) -->
  <div class="row g-4 mt-1">

    <div class="col-12 col-lg-6">
      <div class="panel">
        <h3 class="panel-title"><i class="bi bi-lightning-charge"></i> Accès rapide</h3>
        <p class="muted mt-2 mb-3">Liens utiles (selon permissions).</p>

        <div class="d-grid gap-2">
          <a class="quick-link" th:href="@{/ressources}">
            <i class="bi bi-collection"></i> Gestion des ressources
          </a>
          <a class="quick-link" th:href="@{/exemplaires}">
            <i class="bi bi-stack"></i> Gestion des exemplaires
          </a>

          <a class="quick-link" sec:authorize="hasAuthority('ADMIN')" th:href="@{/bibliotheques}">
            <i class="bi bi-buildings"></i> Gestion des bibliothèques
          </a>

          <a class="quick-link" sec:authorize="hasAuthority('ADMIN')" th:href="@{/admin/users}">
            <i class="bi bi-people"></i> Gestion des utilisateurs
          </a>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="panel">
        <h3 class="panel-title"><i class="bi bi-graph-up-arrow"></i> Vue synthèse</h3>
        <p class="muted mt-2 mb-0">
          Les KPI ci-dessus sont calculés depuis la base (count + countByDisponible).
          Les exports (CSV/PDF) sont réservés à l’ADMIN.
        </p>
      </div>
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
